import{e as t,f as s,g as o,d as he,s as ge,a as te,h as c,o as _e,c as pe,S as se,l as d,F as I,k as j,p as b,L as A,x as M,w as F,v as H,t as D,ac as me,G,H as q,I as P,ad as v,M as f,J as ye,ae,a9 as w,z as xe,A as be,y as T,af as we,ag as J,ah as oe}from"./index-b2d2f6d8.js";function le(L,h){return t(),s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"})])}function ne(L,h){return t(),s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[o("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z","clip-rule":"evenodd"})])}function re(L,h){return t(),s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[o("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z","clip-rule":"evenodd"})])}const Ce={class:"grid grid-cols-2 gap-x-4 p-2"},ke={key:0,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},Ie=o("h1",{class:"text-xl font-semibold border-b pb-2"},"Messaging",-1),Le={key:0,class:"flex flex-col space-y-2 overflow-y-auto max-h-96"},$e={class:"break-words"},Se={key:0,class:"flex justify-between mb-2"},Ae={class:"text-sm font-medium"},Me={class:"text-sm font-medium"},De={key:1,class:"flex justify-center items-center h-32"},Te=o("p",{class:"text-gray-500"},"No messages yet",-1),Ee=[Te],Ne={key:2,class:"flex justify-center items-center h-32"},Re={class:"flex items-end space-x-2"},Ue={key:1},Oe={key:2,class:"flex justify-center items-center h-32"},ze=o("p",{class:"text-gray-500"},"No chatroom found",-1),Be=[ze],Ve={key:3,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},je=o("h1",{class:"text-xl font-semibold border-b pb-2"},"Contract Draft",-1),Fe={key:0},He={key:0},Ge=o("label",null,"Seller clauses",-1),qe={class:"relative break-words"},Pe=["disabled","onUpdate:modelValue"],Je={class:"flex space-x-1 absolute top-1 right-1"},We={key:1},Ke=o("label",null,"Buyer clauses",-1),Qe={class:"relative break-words"},Xe=["disabled","onUpdate:modelValue"],Ye={class:"flex space-x-1 absolute top-1 right-1"},Ze={key:1},et=o("p",null,"No clauses yet",-1),tt=[et],st={key:2},at={key:4},ot=o("p",null,"No Contract Found",-1),lt=[ot],nt={key:5},dt=he({__name:"MessagingView",props:{adId:{type:String,required:!1}},setup(L){const h="chatrooms",W="messages",g="contracts",C="clauses",_=L,{user:i,profile:K}=ge(te()),k=c(!1),p=c(!1),$=c(!1),m=c(!1),S=c({}),l=c({}),u=c([]),y=c({}),x=c([]),de=te().CLAUSE_STATUSES;let E,N,R;const ue=async()=>{k.value=!0;const n=(await me(h,"adId","==",_.adId))[0];n&&(S.value={...n},k.value=!1,E=G(q(v(f,`${h}/${n.id}/${W}`),P("createdAt","asc")),e=>{p.value=!0,x.value=e.docs.map(r=>({...r.data()})),p.value=!1}),N=G(q(v(f,g),ye("adId","==",_.adId),P("createdAt","asc")),e=>{$.value=!0,console.log("contract changed"),l.value=e.docs[0].data(),$.value=!1}),R=G(q(v(f,`${g}/${_.adId}/${C}`),P("createdAt","asc")),e=>{m.value=!0,console.log("clauses changed"),u.value=e.docs.map(r=>({...r.data()})),m.value=!1}))};_e(async()=>{await ue()}),pe(()=>{E&&E(),N&&N(),R&&R()});const Q=c(!1),ie=async()=>{if(Q.value=!0,!S.value||!y.value.text||!i.value||!K.value)return;const a=v(f,h,S.value.id,W);y.value.createdAt=new Date,y.value.senderId=i.value.uid,await ae(a,y.value),Q.value=!1},ce=a=>{const n=new Date,e=a.toDate(),r=n.getTime()-e.getTime(),z=Math.floor(r/1e3),B=Math.floor(z/60),V=Math.floor(B/60),ee=Math.floor(V/24);return ee>0?`${ee} days ago`:V>0?`${V} hours ago`:B>0?`${B} minutes ago`:z>0?`${z} seconds ago`:"just now"},ve=a=>{if(a===0)return!0;const n=x.value[a-1],e=x.value[a];return n.senderId!==e.senderId},fe=async()=>{const a=v(f,`${g}/${l.value.id}/${C}`),n={id:Math.random().toString(36).substring(7),text:"",draft:!0,state:de.PENDING,authorId:i.value.uid,createdAt:new Date,updatedAt:new Date};console.log("onAddClauseDraft",a,l.value.id),await ae(a,n)},X=async a=>{const n=v(f,`${g}/${_.adId}/${C}`);await we(J(n,l.value.id))},Y=async a=>{console.log("onEditClause",a);const n=v(f,`${g}/${_.adId}/${C}`);await oe(J(n,l.value.id),{draft:!0},{merge:!0})},Z=async a=>{console.log("onEditClause",a);const n=v(f,`${g}/${_.adId}/${C}`);await oe(J(n,l.value.id),{draft:!1},{merge:!0})},U=se(()=>{if(!u.value)return[];if(l.value.sellerId!==i.value.uid)return u.value.filter(a=>a.authorId===l.value.sellerId&&!a.draft);u.value.filter(a=>a.authorId===l.value.sellerId)}),O=se(()=>{if(!u.value)return[];if(l.value.buyerId!==i.value.uid)return u.value.filter(a=>a.authorId===l.value.buyerId&&!a.draft);u.value.filter(a=>a.authorId===l.value.buyerId)});return(a,n)=>(t(),s("div",Ce,[S.value&&!k.value&&d(i)&&d(K)?(t(),s("div",ke,[Ie,x.value.length>0&&!p.value?(t(),s("div",Le,[(t(!0),s(I,null,j(x.value,(e,r)=>(t(),s("span",$e,[ve(r)?(t(),s("div",Se,[o("p",Ae,D(e.senderId.substring(0,5))+" says:",1),o("p",Me,D(ce(e.createdAt)),1)])):M("",!0),o("div",{class:w([e.senderId!=d(i).uid?"justify-end":"justify-start","flex"])},[o("p",{class:w([e.senderId===d(i).uid?"bg-blue-500 text-white":"bg-gray-100","rounded-md p-2 max-w-xs md:max-w-md"])},D(e.text),3)],2)]))),256))])):x.value.length==0&&!p.value?(t(),s("div",De,Ee)):p.value?(t(),s("div",Ne,[b(A,{isLoading:p.value},null,8,["isLoading"])])):M("",!0),o("span",Re,[F(o("textarea",{"onUpdate:modelValue":n[0]||(n[0]=e=>y.value.text=e),class:"w-full p-2 border rounded-md resize-none focus:border-blue-500 focus:ring-0",placeholder:"Type your message here...",rows:"1"},null,512),[[H,y.value.text]]),o("button",{onClick:ie,class:"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out"},"Send")])])):k.value?(t(),s("div",Ue,[b(A,{isLoading:k.value},null,8,["isLoading"])])):(t(),s("div",Oe,Be)),$.value?!l.value&&!$.value?(t(),s("div",at,lt)):(t(),s("div",nt,[b(A,{isLoading:m.value},null,8,["isLoading"])])):(t(),s("div",Ve,[je,o("div",null,[o("p",null,"Last Updated: "+D(d(xe)(l.value.updatedAt)?d(be)(l.value.updatedAt):l.value.updatedAt),1)]),o("button",{onClick:fe,class:"w-full border-dashed border-2 border-sky-500 rounded-sm p-1"},"Add Clause"),u.value&&u.value.length>0&&!m.value?(t(),s("div",Fe,[U.value&&U.value.length>0?(t(),s("span",He,[Ge,(t(!0),s(I,null,j(U.value,e=>(t(),s("div",qe,[l.value.sellerId==d(i).uid?(t(),s(I,{key:0},[F(o("textarea",{class:w(["w-full p-2 border rounded-md resize-none focus:border-blue-500 focus:ring-0",[e.draft?"":"bg-gray-200"]]),disabled:!e.draft,"onUpdate:modelValue":r=>e.text=r},null,10,Pe),[[H,e.text]]),o("div",Je,[b(d(re),{class:"h-5 w-5 text-red-400",onClick:r=>X(e.id)},null,8,["onClick"]),e.draft?(t(),T(d(ne),{key:0,class:"h-5 w-5 text-green-400",onClick:r=>Z(e.id)},null,8,["onClick"])):(t(),T(d(le),{key:1,class:"h-5 w-5 text-blue-400",onClick:r=>Y(e.id)},null,8,["onClick"]))])],64)):(t(),s("p",{key:1,class:w(["w-full p-2 border rounded-md",[e.draft?"":"bg-gray-200"]])},null,2))]))),256))])):M("",!0),O.value&&O.value.length>0?(t(),s("span",We,[Ke,(t(!0),s(I,null,j(O.value,e=>(t(),s("div",Qe,[l.value.sellerId==d(i).uid?(t(),s(I,{key:0},[F(o("textarea",{class:w(["w-full p-2 border rounded-md resize-none focus:border-blue-500 focus:ring-0",[e.draft?"":"bg-gray-200"]]),disabled:!e.draft,"onUpdate:modelValue":r=>e.text=r},null,10,Xe),[[H,e.text]]),o("div",Ye,[b(d(re),{class:"h-5 w-5 text-red-400",onClick:r=>X(e.id)},null,8,["onClick"]),e.draft?(t(),T(d(ne),{key:0,class:"h-5 w-5 text-green-400",onClick:r=>Z(e.id)},null,8,["onClick"])):(t(),T(d(le),{key:1,class:"h-5 w-5 text-blue-400",onClick:r=>Y(e.id)},null,8,["onClick"]))])],64)):(t(),s("p",{key:1,class:w(["w-full p-2 border rounded-md",[e.draft?"":"bg-gray-200"]])},null,2))]))),256))])):M("",!0)])):u.value&&u.value.length==0&&!m.value?(t(),s("div",Ze,tt)):(t(),s("div",st,[b(A,{isLoading:m.value},null,8,["isLoading"])]))]))]))}});export{dt as default};
