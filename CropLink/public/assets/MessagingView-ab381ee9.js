import{e as a,f as o,g as s,d as pe,s as xe,a as te,h as v,V as we,o as Ce,ac as ye,c as be,l,F as H,k as J,p as y,L as S,x as m,t as _,w as se,v as ae,ad as ke,G as N,H as j,I as W,ae as f,M as h,J as O,af as P,ag as b,ah as oe,ai as Ee,aj as $e,i as Le,a9 as A,z as De,A as Me,y as ne,ak as Ae,al as Te}from"./index-b6562c70.js";function Ie(k,p){return a(),o("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"})])}function Re(k,p){return a(),o("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"})])}function Se(k,p){return a(),o("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"})])}function Ne(k,p){return a(),o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[s("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z","clip-rule":"evenodd"})])}function je(k,p){return a(),o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[s("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z","clip-rule":"evenodd"})])}const Oe={class:"grid grid-cols-2 gap-x-4 p-2"},Pe={key:0,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},Ue=s("h1",{class:"text-xl font-semibold border-b pb-2"},"Messaging",-1),Be={key:0,class:"flex flex-col space-y-2 overflow-y-auto h-full"},Ve={class:"break-words"},ze={key:0,class:"flex justify-between mb-2"},qe={class:"text-sm font-medium"},Ge={class:"text-sm font-medium"},Fe={class:"flex flex-col space-y-1"},He={key:0,class:"truncate bg-gray-100 rounded-md p-2 max-w-xs md:max-w-md text-xs rounded-md p-1 bg-slate-200"},Je=s("span",{class:"font-bold"},"clause:",-1),We={class:"italic"},Ke={key:1,class:"flex justify-center items-center h-32"},Qe=s("p",{class:"text-gray-500"},"No messages yet",-1),Xe=[Qe],Ye={key:2,class:"flex justify-center items-center h-32"},Ze={class:"flex items-end space-x-2"},et={class:"border rounded-md w-full p-2"},tt={key:0,class:"relative w-full truncate bg-gray-100 rounded-md p-2 max-w-xs md:max-w-md text-xs rounded-md p-1 bg-slate-200"},st={class:"text-sm text-slate-500 truncate"},at=s("span",{class:"font-bold"},"clause: ",-1),ot={class:"italic"},nt={class:"h-full flex items-start"},lt={key:1,class:"flex justify-center items-center h-32"},rt=s("p",{class:"text-gray-500"},"No chatroom found",-1),dt=[rt],it={key:2},ut={key:3,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},ct=s("h1",{class:"text-xl font-semibold border-b pb-2"},"Contract Draft",-1),vt={key:0,class:"flex flex-col space-y-4"},ft={key:0},ht={class:"text-lg font-semibold border-b pb-2"},_t={class:"flex flex-col space-y-2"},gt={class:"relative break-words"},mt=["onUpdate:modelValue"],pt={key:2,class:"w-full flex justify-between"},xt=["onClick"],wt={class:"flex items-center space-x-1 absolute top-1 right-1"},Ct={key:0},yt={class:"text-lg font-semibold border-b pb-2"},bt={class:"flex flex-col space-y-2"},kt={class:"relative break-words"},Et={class:"w-full flex justify-between"},$t=["onClick"],Lt={class:"flex space-x-2"},Dt=["onClick"],Mt=["onClick"],At={class:"w-full flex justify-end"},Tt={key:1},It={key:4},Rt=s("p",null,"No Contract Found",-1),St=[Rt],Nt={key:5},Ot=pe({__name:"MessagingView",props:{adId:{type:String,required:!1}},setup(k){const p="chatrooms",K="messages",g="contracts",w="clauses",Q=k,{user:i,profile:L}=xe(te()),D=v(!1),E=v(!1),T=v(!1),C=v(!1),M=v({}),n=v({}),I=v([]),R=v([]),x=v({}),c=v({}),$=v([]),u=te().CLAUSE_STATUSES;let U,B,V,z;const le=we(n,(t,r)=>{t.id&&(V=N(j(f(h,`${g}/${n.value.id}/${w}`),O("authorId","==",i.value.uid),W("createdAt","asc")),e=>{C.value=!0,console.log("user clauses changed"),I.value=e.docs.map(d=>({...d.data()})),C.value=!1}),z=N(j(f(h,`${g}/${n.value.id}/${w}`),O("authorId","!=",i.value.uid),O("draft","==",!1)),e=>{C.value=!0,console.log("other clauses changed"),R.value=e.docs.map(d=>({...d.data()})),C.value=!1}))}),re=async()=>{D.value=!0;const r=(await ke(p,"adId","==",Q.adId))[0];if(!r)throw new Error("Chatroom not found");M.value={...r},D.value=!1,U=N(j(f(h,`${p}/${r.id}/${K}`),W("createdAt","asc")),e=>{E.value=!0,$.value=e.docs.map(d=>({...d.data()})),E.value=!1}),B=N(j(f(h,g),O("adId","==",Q.adId),W("createdAt","asc")),e=>{T.value=!0,console.log("contract changed"),n.value=e.docs[0].data(),T.value=!1})};Ce(async()=>{try{await re()}catch(t){t.message=="Chatroom not found"&&ye.push("/")}}),be(()=>{U&&U(),B&&B(),V&&V(),z&&z(),le()});const X=v(!1),de=async()=>{if(X.value=!0,!M.value||!x.value.text||!i.value||!L.value)return;const t=f(h,p,M.value.id,K);x.value.quote=c.value,x.value.createdAt=new Date,x.value.senderId=i.value.uid,await Ae(t,x.value),x.value.text="",c.value={},X.value=!1},ie=t=>{const r=new Date,e=t.toDate(),d=r.getTime()-e.getTime(),q=Math.floor(d/1e3),G=Math.floor(q/60),F=Math.floor(G/60),ee=Math.floor(F/24);return ee>0?`${ee} days ago`:F>0?`${F} hours ago`:G>0?`${G} minutes ago`:q>0?`${q} seconds ago`:"just now"},ue=t=>{if(t===0)return!0;const r=$.value[t-1],e=$.value[t];return r.senderId!==e.senderId},Y=t=>{!t||!t.id||t.draft||(c.value=t)},ce=()=>{c.value={}},ve=async()=>{const t=f(h,`${g}/${n.value.id}/${w}`),r={id:Math.random().toString(36).substring(7),text:"",draft:!0,state:u.PENDING,authorId:i.value.uid,createdAt:new Date,updatedAt:new Date};console.log("onAddClauseDraft",t,r.id),await P(b(t,r.id),r)},fe=async t=>{if(console.log("onRemoveClause",t),!t||!n.value.id)return;const r=f(h,`${g}/${n.value.id}/${w}`);await Te(b(r,t)),c.value.id==t&&(c.value={})},he=async t=>{if(console.log("onEditClause",t),!t||!n.value.id)return;const r=f(h,`${g}/${n.value.id}/${w}`);await P(b(r,t),{draft:!0},{merge:!0}),c.value.id==t&&(c.value={})},Z=async(t,r)=>{if(console.log("onEditClause",t,r),!t||!n.value.id||!Object.values(u).includes(r))return;const e=f(h,`${g}/${n.value.id}/${w}`);await P(b(e,t),{state:r},{merge:!0}),c.value.id==t&&(c.value={})},_e=async t=>{if(console.log("onEditClause",t),!t||!n.value.id)return;t.draft=!1;const r=f(h,`${g}/${n.value.id}/${w}`);await P(b(r,t.id),t,{merge:!0})},ge=async()=>{if(!n.value.id||i.value.uid||n.value.ready.includes(i.value.uid))return;const t=f(h,g);await oe(b(t,n.value.id),{ready:Ee(i.value.uid)})},me=async()=>{if(!n.value.id||i.value.uid||!n.value.ready.includes(i.value.uid))return;const t=f(h,g);await oe(b(t,n.value.id),{ready:$e(i.value.uid)})};return(t,r)=>(a(),o("div",Oe,[M.value.id&&!D.value&&l(i)&&l(L)?(a(),o("div",Pe,[Ue,$.value.length>0&&!E.value?(a(),o("div",Be,[(a(!0),o(H,null,J($.value,(e,d)=>(a(),o("span",Ve,[ue(d)?(a(),o("div",ze,[s("p",qe,_(e.senderId.substring(0,5))+" says:",1),s("p",Ge,_(ie(e.createdAt)),1)])):m("",!0),s("div",{class:A([e.senderId!=l(i).uid?"justify-end":"justify-start","flex"])},[s("div",Fe,[e.quote?(a(),o("p",He,[Je,Le(),s("span",We,_(e.quote.text),1)])):m("",!0),s("p",{class:A([e.senderId===l(i).uid?"bg-blue-500 text-white":"bg-gray-100","rounded-md p-2 max-w-xs md:max-w-md",e.quote?"ml-2":""])},_(e.text),3)])],2)]))),256))])):$.value.length==0&&!E.value?(a(),o("div",Ke,Xe)):E.value?(a(),o("div",Ye,[y(S,{isLoading:E.value},null,8,["isLoading"])])):m("",!0),s("span",Ze,[s("div",et,[c.value.id?(a(),o("div",tt,[y(l(je),{class:"h-4 w-4 absolute top-1 right-1",onClick:ce}),s("p",st,[at,s("span",ot,_(c.value.text),1)])])):m("",!0),se(s("textarea",{"onUpdate:modelValue":r[0]||(r[0]=e=>x.value.text=e),class:"h-full w-full resize-none focus:outline-none",placeholder:"Type your message here..."},null,512),[[ae,x.value.text]])]),s("div",nt,[y(l(Ie),{onClick:de,class:"h-6 w-6 text-blue-500"})])])])):!M.value.id&&!D.value?(a(),o("div",lt,dt)):(a(),o("div",it,[y(S,{isLoading:D.value},null,8,["isLoading"])])),n.value.id&&!T.value?(a(),o("div",ut,[ct,s("div",null,[s("p",null,"Last Updated: "+_(l(De)(n.value.updatedAt)?l(Me)(n.value.updatedAt):n.value.updatedAt),1)]),s("button",{onClick:ve,class:"w-full border-dashed border-2 border-sky-500 rounded-sm p-1"},"Add Clause"),C.value?(a(),o("div",Tt,[y(S,{isLoading:C.value},null,8,["isLoading"])])):(a(),o("div",vt,[s("span",null,[I.value&&I.value.length>0?(a(),o("span",ft,[s("label",ht,_(l(L)&&l(L).name?`${l(L).name}'s `:"My ")+"clauses",1),s("span",_t,[(a(!0),o(H,null,J(I.value,e=>(a(),o("div",gt,[e.draft?se((a(),o("textarea",{key:0,class:"w-full p-2 border rounded-md resize-none focus:border-blue-500 focus:ring-0","onUpdate:modelValue":d=>e.text=d},null,8,mt)),[[ae,e.text]]):(a(),o("p",{key:1,class:A(["w-full p-2 border rounded-md",{"bg-gray-200":e.state==l(u).PENDING,"bg-green-200":e.state==l(u).ACCEPTED,"bg-red-200":e.state==l(u).REJECTED}])},_(e.text),3)),e.state!=l(u).PENDING?(a(),o("div",pt,[e.draft?m("",!0):(a(),o("p",{key:0,class:"text-xs underline",onClick:d=>Y(e)},"Mention",8,xt)),s("p",{class:A({"text-green-400 text-xs":e.state==l(u).ACCEPTED,"text-red-400 text-xs":e.state==l(u).REJECTED})},_(e.state),3)])):m("",!0),s("div",wt,[e.draft?(a(),ne(l(Ne),{key:0,class:"h-4 w-4 text-green-400",onClick:d=>_e(e)},null,8,["onClick"])):(a(),ne(l(Re),{key:1,class:"h-4 w-4 text-blue-400",onClick:d=>he(e.id)},null,8,["onClick"])),y(l(Se),{class:"h-4 w-4",onClick:d=>fe(e.id)},null,8,["onClick"])])]))),256))])])):m("",!0)]),s("span",null,[R.value&&R.value.length>0?(a(),o("span",Ct,[s("label",yt,_(l(i).name==n.value.sellerId?n.value.sellerId.substring(0,5):n.value.buyerId.substring(0,5))+"'s clauses",1),s("span",bt,[(a(!0),o(H,null,J(R.value,e=>(a(),o("div",kt,[s("p",{class:A(["w-full p-2 border rounded-md",{"bg-gray-200":e.state==l(u).PENDING,"bg-green-200":e.state==l(u).ACCEPTED,"bg-red-200":e.state==l(u).REJECTED}])},_(e.text),3),s("div",Et,[s("a",{class:"text-xs underline",onClick:d=>Y(e)},"Mention",8,$t),s("div",Lt,[s("a",{class:"text-xs font-semibold text-green-400 underline decoration-green-400",onClick:d=>Z(e.id,l(u).ACCEPTED)},"Approve",8,Dt),s("a",{class:"text-xs font-semibold text-red-400 underline decoration-red-400",onClick:d=>Z(e.id,l(u).REJECTED)},"Reject",8,Mt)])])]))),256))])])):m("",!0)]),s("div",At,[n.value.ready.includes(l(i).uid)?m("",!0):(a(),o("button",{key:0,onClick:ge,class:"bg-blue-500 text-white px-4 h-8 rounded-md hover:bg-blue-400 transition duration-300 ease-in-out"},"Ready to Proceed ")),n.value.ready.includes(l(i).uid)?(a(),o("button",{key:1,onClick:me,class:"bg-red-500 text-white px-4 h-8 rounded-md hover:bg-red-400 transition duration-300 ease-in-out"},"Cancel ")):m("",!0)])]))])):!n.value.id&&!T.value?(a(),o("div",It,St)):(a(),o("div",Nt,[y(S,{isLoading:C.value},null,8,["isLoading"])]))]))}});export{Ot as default};
