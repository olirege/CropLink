import{e as o,f as n,g as s,d as me,s as xe,a as te,h as _,V as ye,o as we,ac as Ce,c as be,l,F as J,k as W,p as k,L as O,x as v,t as f,w as se,v as ae,ad as ke,G as U,H as B,I as Y,ae as g,M as p,J as V,af as z,ag as E,ah as oe,ai as Ee,aj as $e,i as Le,a9 as S,z as De,A as Ie,y as ne,ak as Me,al as Te}from"./index-acab8f34.js";function Ae($,y){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"})])}function Re($,y){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"})])}function Se($,y){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"})])}function Ne($,y){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[s("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z","clip-rule":"evenodd"})])}function je($,y){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[s("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z","clip-rule":"evenodd"})])}const Pe={class:"grid grid-cols-2 gap-x-4 p-2"},Oe={key:0,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},Ue=s("h1",{class:"text-xl font-semibold border-b pb-2"},"Messaging",-1),Be={key:0,class:"flex flex-col space-y-2 overflow-y-auto h-full"},Ve={class:"break-words"},ze={key:0,class:"flex justify-between mb-2"},qe={class:"text-sm font-medium"},Ge={class:"text-sm font-medium"},Fe={class:"flex flex-col space-y-1"},He={key:0,class:"truncate bg-gray-100 rounded-md p-2 max-w-xs md:max-w-md text-xs rounded-md p-1 bg-slate-200"},Je=s("span",{class:"font-bold"},"clause:",-1),We={class:"italic"},Ye={key:1,class:"flex justify-center items-center h-32"},Ke=s("p",{class:"text-gray-500"},"No messages yet",-1),Qe=[Ke],Xe={key:2,class:"flex justify-center items-center h-32"},Ze={class:"flex items-end space-x-2"},et={class:"border rounded-md w-full p-2"},tt={key:0,class:"relative w-full truncate bg-gray-100 rounded-md p-2 max-w-xs md:max-w-md text-xs rounded-md p-1 bg-slate-200"},st={class:"text-sm text-slate-500 truncate"},at=s("span",{class:"font-bold"},"clause: ",-1),ot={class:"italic"},nt={class:"h-full flex items-start"},lt={key:1,class:"flex justify-center items-center h-32"},dt=s("p",{class:"text-gray-500"},"No chatroom found",-1),rt=[dt],ut={key:2},it={key:3,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},ct=s("h1",{class:"text-xl font-semibold border-b pb-2"},"Contract Draft",-1),vt={key:0,class:"flex flex-col space-y-4"},ft={key:0},ht={class:"text-lg font-semibold border-b pb-2"},_t={class:"flex flex-col space-y-2"},gt={class:"relative break-words"},pt=["onUpdate:modelValue"],mt={key:2,class:"w-full flex justify-between"},xt=["onClick"],yt={class:"flex items-center space-x-1 absolute top-1 right-1"},wt={key:0},Ct={class:"text-lg font-semibold border-b pb-2"},bt={class:"flex flex-col space-y-2"},kt={class:"relative break-words"},Et={class:"w-full flex justify-between"},$t=["onClick"],Lt={class:"flex space-x-2"},Dt=["onClick"],It=["onClick"],Mt={class:"w-full flex justify-between"},Tt={key:0},At={key:0},Rt={key:1},St={key:1},Nt={key:4},jt=s("p",null,"No Contract Found",-1),Pt=[jt],Ot={key:5},Bt=me({__name:"MessagingView",props:{adId:{type:String,required:!1}},setup($){const y="chatrooms",K="messages",m="contracts",C="clauses",Q=$,{user:r,profile:T}=xe(te()),A=_(!1),L=_(!1),N=_(!1),b=_(!1),R=_({}),e=_({}),j=_([]),P=_([]),w=_({}),h=_({}),D=_([]),i=te().CLAUSE_STATUSES;let q,G,F,H;const le=ye(e,(t,d)=>{t.id&&(F=U(B(g(p,`${m}/${e.value.id}/${C}`),V("authorId","==",r.value.uid),Y("createdAt","asc")),u=>{b.value=!0,console.log("user clauses changed"),j.value=u.docs.map(x=>({...x.data()})),b.value=!1}),H=U(B(g(p,`${m}/${e.value.id}/${C}`),V("authorId","!=",r.value.uid),V("draft","==",!1)),u=>{b.value=!0,console.log("other clauses changed"),P.value=u.docs.map(x=>({...x.data()})),b.value=!1}))}),de=async()=>{A.value=!0;const d=(await ke(y,"adId","==",Q.adId))[0];if(!d)throw new Error("Chatroom not found");R.value={...d},A.value=!1,q=U(B(g(p,`${y}/${d.id}/${K}`),Y("createdAt","asc")),u=>{L.value=!0,D.value=u.docs.map(x=>({...x.data()})),L.value=!1}),G=U(B(g(p,m),V("adId","==",Q.adId),Y("createdAt","asc")),u=>{N.value=!0,console.log("contract changed"),e.value=u.docs[0].data(),N.value=!1})};we(async()=>{try{await de()}catch(t){t.message=="Chatroom not found"&&Ce.push("/")}}),be(()=>{q&&q(),G&&G(),F&&F(),H&&H(),le()});const X=_(!1),re=async()=>{if(X.value=!0,!R.value||!w.value.text||!r.value||!T.value)return;const t=g(p,y,R.value.id,K);w.value.quote=h.value,w.value.createdAt=new Date,w.value.senderId=r.value.uid,await Me(t,w.value),w.value.text="",h.value={},X.value=!1},ue=t=>{const d=new Date,u=t.toDate(),x=d.getTime()-u.getTime(),I=Math.floor(x/1e3),M=Math.floor(I/60),a=Math.floor(M/60),c=Math.floor(a/24);return c>0?`${c} days ago`:a>0?`${a} hours ago`:M>0?`${M} minutes ago`:I>0?`${I} seconds ago`:"just now"},ie=t=>{if(t===0)return!0;const d=D.value[t-1],u=D.value[t];return d.senderId!==u.senderId},Z=t=>{!t||!t.id||t.draft||(h.value=t)},ce=()=>{h.value={}},ve=async()=>{const t=g(p,`${m}/${e.value.id}/${C}`),d={id:Math.random().toString(36).substring(7),text:"",draft:!0,state:i.PENDING,authorId:r.value.uid,createdAt:new Date,updatedAt:new Date};console.log("onAddClauseDraft",t,d.id),await z(E(t,d.id),d)},fe=async t=>{if(console.log("onRemoveClause",t),!t||!e.value.id)return;const d=g(p,`${m}/${e.value.id}/${C}`);await Te(E(d,t)),h.value.id==t&&(h.value={})},he=async t=>{if(console.log("onEditClause",t),!t||!e.value.id)return;const d=g(p,`${m}/${e.value.id}/${C}`);await z(E(d,t),{draft:!0},{merge:!0}),h.value.id==t&&(h.value={})},ee=async(t,d)=>{if(console.log("onEditClause",t,d),!t||!e.value.id||!Object.values(i).includes(d))return;const u=g(p,`${m}/${e.value.id}/${C}`);await z(E(u,t),{state:d},{merge:!0}),h.value.id==t&&(h.value={})},_e=async t=>{if(console.log("onEditClause",t),!t||!e.value.id)return;t.draft=!1;const d=g(p,`${m}/${e.value.id}/${C}`);await z(E(d,t.id),t,{merge:!0})},ge=async()=>{if(console.log(e.value),!e.value.id||!r.value.uid||e.value&&e.value.ready&&e.value.ready.includes(r.value.uid))return;console.log("onReadyToProceed",e.value.id,r.value.uid);const t=g(p,m);await oe(E(t,e.value.id),{ready:Ee(r.value.uid)})},pe=async()=>{if(!e.value.id||!r.value.uid||e.value&&e.value.ready&&!e.value.ready.includes(r.value.uid))return;console.log("onCancelReadyToProceed",e.value.id,r.value.uid);const t=g(p,m);await oe(E(t,e.value.id),{ready:$e(r.value.uid)})};return(t,d)=>{var u,x,I,M;return o(),n("div",Pe,[R.value.id&&!A.value&&l(r)&&l(T)?(o(),n("div",Oe,[Ue,D.value.length>0&&!L.value?(o(),n("div",Be,[(o(!0),n(J,null,W(D.value,(a,c)=>(o(),n("span",Ve,[ie(c)?(o(),n("div",ze,[s("p",qe,f(a.senderId.substring(0,5))+" says:",1),s("p",Ge,f(ue(a.createdAt)),1)])):v("",!0),s("div",{class:S([a.senderId!=l(r).uid?"justify-end":"justify-start","flex"])},[s("div",Fe,[a.quote&&a.quote.text?(o(),n("p",He,[Je,Le(),s("span",We,f(a.quote.text),1)])):v("",!0),s("p",{class:S([a.senderId===l(r).uid?"bg-blue-500 text-white":"bg-gray-100","rounded-md p-2 max-w-xs md:max-w-md",a.quote?"ml-2":""])},f(a.text),3)])],2)]))),256))])):D.value.length==0&&!L.value?(o(),n("div",Ye,Qe)):L.value?(o(),n("div",Xe,[k(O,{isLoading:L.value},null,8,["isLoading"])])):v("",!0),s("span",Ze,[s("div",et,[h.value.id?(o(),n("div",tt,[k(l(je),{class:"h-4 w-4 absolute top-1 right-1",onClick:ce}),s("p",st,[at,s("span",ot,f(h.value.text),1)])])):v("",!0),se(s("textarea",{"onUpdate:modelValue":d[0]||(d[0]=a=>w.value.text=a),class:"h-full w-full resize-none focus:outline-none",placeholder:"Type your message here..."},null,512),[[ae,w.value.text]])]),s("div",nt,[k(l(Ae),{onClick:re,class:"h-6 w-6 text-blue-500"})])])])):!R.value.id&&!A.value?(o(),n("div",lt,rt)):(o(),n("div",ut,[k(O,{isLoading:A.value},null,8,["isLoading"])])),e.value.id&&!N.value?(o(),n("div",it,[ct,s("div",null,[s("p",null,"Last Updated: "+f(l(De)(e.value.updatedAt)?l(Ie)(e.value.updatedAt):e.value.updatedAt),1)]),s("button",{onClick:ve,class:"w-full border-dashed border-2 border-sky-500 rounded-sm p-1"},"Add Clause"),b.value?(o(),n("div",St,[k(O,{isLoading:b.value},null,8,["isLoading"])])):(o(),n("div",vt,[s("span",null,[j.value&&j.value.length>0?(o(),n("span",ft,[s("label",ht,f(l(T)&&l(T).name?`${l(T).name}'s `:"Your ")+"clauses",1),s("span",_t,[(o(!0),n(J,null,W(j.value,a=>(o(),n("div",gt,[a.draft?se((o(),n("textarea",{key:0,class:"w-full p-2 border rounded-md resize-none focus:border-blue-500 focus:ring-0","onUpdate:modelValue":c=>a.text=c},null,8,pt)),[[ae,a.text]]):(o(),n("p",{key:1,class:S(["w-full p-2 border rounded-md",{"bg-gray-200":a.state==l(i).PENDING,"bg-green-200":a.state==l(i).ACCEPTED,"bg-red-200":a.state==l(i).REJECTED}])},f(a.text),3)),a.state!=l(i).PENDING?(o(),n("div",mt,[a.draft?v("",!0):(o(),n("p",{key:0,class:"text-xs underline",onClick:c=>Z(a)},"Mention",8,xt)),s("p",{class:S({"text-green-400 text-xs":a.state==l(i).ACCEPTED,"text-red-400 text-xs":a.state==l(i).REJECTED})},f(a.state),3)])):v("",!0),s("div",yt,[a.draft?(o(),ne(l(Ne),{key:0,class:"h-5 w-5 text-green-400",onClick:c=>_e(a)},null,8,["onClick"])):(o(),ne(l(Re),{key:1,class:"h-5 w-5 text-blue-400",onClick:c=>he(a.id)},null,8,["onClick"])),k(l(Se),{class:"h-5 w-5",onClick:c=>fe(a.id)},null,8,["onClick"])])]))),256))])])):v("",!0)]),s("span",null,[P.value&&P.value.length>0?(o(),n("span",wt,[s("label",Ct,f(l(r).name==e.value.sellerId?e.value.sellerId.substring(0,5):e.value.buyerId.substring(0,5))+"'s clauses",1),s("span",bt,[(o(!0),n(J,null,W(P.value,a=>(o(),n("div",kt,[s("p",{class:S(["w-full p-2 border rounded-md",{"bg-gray-200":a.state==l(i).PENDING,"bg-green-200":a.state==l(i).ACCEPTED,"bg-red-200":a.state==l(i).REJECTED}])},f(a.text),3),s("div",Et,[s("a",{class:"text-xs underline",onClick:c=>Z(a)},"Mention",8,$t),s("div",Lt,[s("a",{class:"text-xs font-semibold text-green-400 underline decoration-green-400",onClick:c=>ee(a.id,l(i).ACCEPTED)},"Approve",8,Dt),s("a",{class:"text-xs font-semibold text-red-400 underline decoration-red-400",onClick:c=>ee(a.id,l(i).REJECTED)},"Reject",8,It)])])]))),256))])])):v("",!0)]),s("div",Mt,[!((u=e.value.ready)!=null&&u.includes(e.value.sellerId))||!((x=e.value.ready)!=null&&x.includes(e.value.buyerId))?(o(),n("p",Tt,[(I=e.value.ready)!=null&&I.includes(e.value.sellerId)?(o(),n("span",At,f(e.value.sellerId.substring(0,5))+" is ready",1)):v("",!0),(M=e.value.ready)!=null&&M.includes(e.value.buyerId)?(o(),n("span",Rt,f(e.value.buyerId.substring(0,5))+" is ready",1)):v("",!0)])):v("",!0),e.value.ready.includes(l(r).uid)?v("",!0):(o(),n("button",{key:1,onClick:ge,class:"bg-blue-500 text-white px-4 h-8 rounded-md hover:bg-blue-400 transition duration-300 ease-in-out"},"Ready to Proceed ")),e.value.ready.includes(l(r).uid)?(o(),n("button",{key:2,onClick:pe,class:"bg-red-500 text-white px-4 h-8 rounded-md hover:bg-red-400 transition duration-300 ease-in-out"},"Cancel ")):v("",!0)])]))])):!e.value.id&&!N.value?(o(),n("div",Nt,Pt)):(o(),n("div",Ot,[k(O,{isLoading:b.value},null,8,["isLoading"])]))])}}});export{Bt as default};
