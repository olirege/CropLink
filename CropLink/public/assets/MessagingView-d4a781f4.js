import{e as a,f as o,k as s,d as oe,s as K,n as W,a as ae,u as ce,r as x,o as le,c as re,C as l,F,m as Q,p as w,L as X,A as p,t as f,w as de,v as ie,j as ue,X as q,J as ve,aE as fe,aF as V,aG as S,aH as A,aI as _e,O as ge,aJ as he,B as se,q as pe,y as me,aK as Y,aL as P,aM as ne,aN as xe,aO as be,z as ye,a1 as Ce,a3 as we,aP as $e,a2 as Ie,aQ as ke,aR as Ee}from"./index-d4d9ec3f.js";import{r as Re}from"./CheckCircleIcon-0c27dbb8.js";function Te(R,D){return a(),o("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"})])}const Me={key:0,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},Se=s("h1",{class:"text-xl font-semibold border-b pb-2"},"Messaging",-1),Ae={key:0,class:"flex flex-col space-y-2 overflow-y-auto h-full"},De={class:"break-words"},Le={key:0,class:"flex justify-between mb-2"},Ne={class:"text-sm font-medium"},Oe={class:"text-sm font-medium"},Pe={class:"flex flex-col space-y-1"},je={key:0,class:"truncate bg-gray-100 rounded-md p-2 max-w-xs md:max-w-md text-xs rounded-md p-1 bg-slate-200"},Ue=s("span",{class:"font-bold"},"clause:",-1),Fe={class:"italic"},qe={key:1,class:"flex justify-center items-center h-32 flex-grow"},Ve=s("p",{class:"text-gray-500"},"No messages yet",-1),Be=[Ve],ze={key:2,class:"flex justify-center items-center h-32 flex-grow"},Ge={class:"flex items-end space-x-2"},He={class:"border rounded-md w-full p-2"},Je={key:0,class:"relative w-full truncate bg-gray-100 rounded-md p-2 max-w-xs md:max-w-md text-xs rounded-md p-1 bg-slate-200"},Ye={class:"text-sm text-slate-500 truncate"},Qe=s("span",{class:"font-bold"},"clause: ",-1),Ke={class:"italic"},We={class:"h-full flex items-start"},Xe={key:1,class:"flex justify-center items-center h-32"},Ze=s("p",{class:"text-gray-500"},"No chatroom found",-1),et=[Ze],tt={key:2},st=oe({__name:"ChatRoomComponent",props:{clauseMentionned:{type:Object,default:{}},adId:{type:String,required:!0}},emits:["onRemoveMentionnedClause"],setup(R,{emit:D}){const{notifications:r}=K(W()),$=W().NOTIFICATION_TYPES,b=D,m=R,{user:y,profile:c}=K(ae()),j=ce(),L="chatrooms",M="messages",e=x(!1),I=x(!1),C=x({}),_=x({}),u=x([]);let N;const U=async()=>{const v=[["createdAt","asc"]],g=[],d=`${L}/${C.value.id}/${M}`,{subscribe:k,unsubscribe:T}=V(d,g,v,t=>{u.value=t},t=>{r.value.show=!0,r.value.type=$.ERROR,r.value.message="Error loading messages, please try again later"},I);N=T,k()};let O;const Z=async()=>{const v=L,g=[["adId","==",m.adId]],d=[],{subscribe:k,unsubscribe:T}=V(v,g,d,t=>{t.length>0&&(C.value=t[0],U())},t=>{r.value.show=!0,r.value.type=$.ERROR,r.value.message="Error loading chatroom, please try again later"},e);O=T,k()};le(async()=>{try{await Z()}catch(v){v.message=="Chatroom not found"&&j.push("/")}}),re(()=>{N&&N(),O&&O()});const B=x(!1),ee=async()=>{if(B.value=!0,!C.value||!_.value.text||!y.value||!c.value)return;const v=S(A,L,C.value.id,M);_.value.quote=m.clauseMentionned,_.value.createdAt=new Date,_.value.senderId=y.value.uid,await _e(v,_.value),_.value.text="",b("onRemoveMentionnedClause"),B.value=!1},te=v=>{const g=new Date,d=v.toDate(),k=g.getTime()-d.getTime(),T=Math.floor(k/1e3),t=Math.floor(T/60),i=Math.floor(t/60),h=Math.floor(i/24);return h>0?`${h} days ago`:i>0?`${i} hours ago`:t>0?`${t} minutes ago`:T>0?`${T} seconds ago`:"just now"},z=v=>{if(v===0)return!0;const g=u.value[v-1],d=u.value[v];return g.senderId!==d.senderId||g.createdAt.toDate().getHours()!==d.createdAt.toDate().getHours()};return(v,g)=>C.value.id&&!e.value&&l(y)&&l(c)?(a(),o("div",Me,[Se,u.value.length>0&&!I.value?(a(),o("div",Ae,[(a(!0),o(F,null,Q(u.value,(d,k)=>(a(),o("span",De,[z(k)?(a(),o("div",Le,[s("p",Ne,f(d.senderId.substring(0,5))+" says:",1),s("p",Oe,f(te(d.createdAt)),1)])):p("",!0),s("div",{class:q([d.senderId!=l(y).uid?"justify-end":"justify-start","flex"])},[s("div",Pe,[d.quote&&d.quote.text?(a(),o("p",je,[Ue,ue(),s("span",Fe,f(d.quote.text),1)])):p("",!0),s("p",{class:q([d.senderId===l(y).uid?"bg-blue-500 text-white":"bg-gray-100","rounded-md p-2 max-w-xs md:max-w-md",d.quote?"ml-2":""])},f(d.text),3)])],2)]))),256))])):u.value.length==0&&!I.value?(a(),o("div",qe,Be)):I.value?(a(),o("div",ze,[w(X,{isLoading:I.value},null,8,["isLoading"])])):p("",!0),s("span",Ge,[s("div",He,[R.clauseMentionned.id?(a(),o("div",Je,[w(l(ve),{class:"h-4 w-4 absolute top-1 right-1",onClick:g[0]||(g[0]=d=>v.$emit("onRemoveMentionnedClause"))}),s("p",Ye,[Qe,s("span",Ke,f(R.clauseMentionned.text),1)])])):p("",!0),de(s("textarea",{"onUpdate:modelValue":g[1]||(g[1]=d=>_.value.text=d),class:"h-full w-full resize-none focus:outline-none",placeholder:"Type your message here..."},null,512),[[ie,_.value.text]])]),s("div",We,[w(l(fe),{onClick:ee,class:"h-6 w-6 text-blue-500"})])])])):!C.value.id&&!e.value?(a(),o("div",Xe,et)):(a(),o("div",tt,[w(X,{isLoading:e.value},null,8,["isLoading"])]))}}),at={key:0,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},ot=s("h1",{class:"text-xl font-semibold border-b pb-2"},"Contract Draft",-1),nt={key:0},lt={class:"grid"},rt={class:"flex flex-col"},dt=s("label",{class:"text-lg font-semibold border-b pb-2"},"Milestones:",-1),it={class:"w-full p-2 border rounded-md resize-none focus:border-blue-500 focus:ring-0 flex flex-col gap-2"},ut={class:"flex flex-row justify-between"},ct={class:"flex flex-row items-center gap-2"},vt={class:"font-bold text-xl"},ft={class:"italic text-xl"},_t={class:"flex flex-row gap-4"},gt={key:1,class:"flex flex-col space-y-4"},ht={key:0},pt={class:"text-lg font-semibold border-b pb-2"},mt={class:"flex flex-col space-y-2"},xt={class:"relative break-words"},bt=["onUpdate:modelValue"],yt={key:2,class:"w-full flex justify-between"},Ct=["onClick"],wt={class:"flex items-center space-x-1 absolute top-1 right-1"},$t={key:0},It={class:"text-lg font-semibold border-b pb-2"},kt={class:"flex flex-col space-y-2"},Et={class:"relative break-words"},Rt={class:"w-full flex justify-between"},Tt=["onClick"],Mt={class:"flex space-x-2"},St=["onClick"],At=["onClick"],Dt={class:"w-full flex justify-between"},Lt={key:0,class:"text-xs"},Nt={key:1,class:"text-xs"},Ot={key:2},Pt={key:1},jt=s("p",null,"No Contract Found",-1),Ut=[jt],Ft={key:2},qt=oe({__name:"ContractComponent",props:{adId:{type:String,required:!0}},emits:["onMentionClause"],setup(R,{emit:D}){const{notifications:r}=K(W()),$=W().NOTIFICATION_TYPES,b=R,m="contracts",y="clauses",{user:c,profile:j}=K(ae()),L=x(!1),M=x(!1),e=x({}),I=x([]),C=x([]),_=x({}),u=ae().CLAUSE_STATUSES;let N,U,O;const Z=ge(e,async(t,i)=>{if(t.id){const{subscribe:h,unsubscribe:G}=V(`${m}/${e.value.id}/${y}`,[["authorId","==",c.value.uid]],["createdAt","asc"],n=>{I.value=n},n=>{r.value.show=!0,r.value.type=$.ERROR,r.value.message="Error loading clauses, please try again later"},M);U=G,h();const{subscribe:H,unsubscribe:J}=V(`${m}/${e.value.id}/${y}`,[["authorId","!=",c.value.uid],["draft","==",!1]],[],n=>{C.value=n},n=>{r.value.show=!0,r.value.type=$.ERROR,r.value.message="Error loading clauses, please try again later"},M);O=J,H()}}),B=async()=>{const t=S(A,`${m}/${e.value.id}/${y}`),i={id:Math.random().toString(36).substring(7),text:"",draft:!0,state:u.PENDING,authorId:c.value.uid,createdAt:new Date,updatedAt:new Date};console.log("onAddClauseDraft",t,i.id),await Y(P(t,i.id),i)},ee=async t=>{if(console.log("onRemoveClause",t),!t||!e.value.id)return;const i=S(A,`${m}/${e.value.id}/${y}`);await ke(P(i,t)),_.value.id==t&&(_.value={})},te=async t=>{if(console.log("onEditClause",t),!t||!e.value.id)return;const i=S(A,`${m}/${e.value.id}/${y}`);await Y(P(i,t),{draft:!0},{merge:!0}),_.value.id==t&&(_.value={})},z=async(t,i)=>{if(console.log("onEditClause",t,i),!t||!e.value.id||!Object.values(u).includes(i))return;const h=S(A,`${m}/${e.value.id}/${y}`);await Y(P(h,t),{state:i},{merge:!0}),_.value.id==t&&(_.value={})},v=async t=>{if(console.log("onEditClause",t),!t||!e.value.id)return;t.draft=!1;const i=S(A,`${m}/${e.value.id}/${y}`);await Y(P(i,t.id),t,{merge:!0})},g=async()=>{if(console.log(e.value),!e.value.id||!c.value.uid||e.value&&e.value.ready&&e.value.ready.includes(c.value.uid))return;console.log("onReadyToProceed",e.value.id,c.value.uid);const t=S(A,m);await ne(P(t,e.value.id),{ready:xe(c.value.uid)})},d=async()=>{if(!e.value.id||!c.value.uid||e.value&&e.value.ready&&!e.value.ready.includes(c.value.uid))return;console.log("onCancelReadyToProceed",e.value.id,c.value.uid);const t=S(A,m);await ne(P(t,e.value.id),{ready:be(c.value.uid)})},k=x(!1),T=async()=>{if(!b.adId)return;console.log("onProceed",b.adId,e.value.id);let t;const{callFunction:i}=ye("createTransaction",{adId:b.adId,contractId:e.value.id},k,void 0,h=>{t=h},()=>{r.value.show=!0,r.value.type=$.SUCCESS,r.value.message="Contract created successfully"},h=>{r.value.show=!0,r.value.type=$.ERROR,r.value.message="Error while creating contract, please try again later"});await i(),t&&t.data.landingPage&&Ee.push({name:"banking",params:{adId:b.adId,contractId:e.value.id}})};return le(async()=>{const{subscribe:t,unsubscribe:i}=V(m,[["adId","==",b.adId]],["createdAt","asc"],h=>{e.value=h[0]},h=>{r.value.show=!0,r.value.type=$.ERROR,r.value.message="Error loading contract, please try again later"},L);N=i,t()}),re(()=>{N&&N(),U&&U(),O&&O(),Z()}),(t,i)=>{var h,G,H,J;return e.value.id&&!L.value?(a(),o("div",at,[ot,s("div",null,[s("p",null,"Last Updated: "+f(l(Ce)(e.value.updatedAt)?l(we)(e.value.updatedAt):e.value.updatedAt),1)]),e.value.context?(a(),o("div",nt,[e.value.type=="gig"?(a(),o(F,{key:0},[s("div",lt,[w(he,{gig:e.value.context},null,8,["gig"])]),s("div",rt,[dt,(a(!0),o(F,null,Q(e.value.context.milestones,(n,E)=>(a(),o("span",it,[s("span",ut,[s("span",ct,[s("p",vt,f(E+1+"."),1),s("p",ft,f(n.name),1)]),s("span",_t,[w(l($e),{class:"h-6 w-6"}),s("p",null,f(n.price),1)])]),s("p",null,f(n.description.substring(0,300)+"..."),1)]))),256))])],64)):p("",!0)])):p("",!0),s("button",{onClick:B,class:"w-full border-dashed border-2 border-sky-500 rounded-sm p-1"},"Add Clause"),M.value?(a(),o("div",Ot,[w(X,{isLoading:M.value},null,8,["isLoading"])])):(a(),o("div",gt,[s("span",null,[I.value&&I.value.length>0?(a(),o("span",ht,[s("label",pt,f(l(j)&&l(j).name?`${l(j).name}'s `:"Your ")+"clauses",1),s("span",mt,[(a(!0),o(F,null,Q(I.value,n=>(a(),o("div",xt,[n.draft?de((a(),o("textarea",{key:0,class:"w-full p-2 border rounded-md resize-none focus:border-blue-500 focus:ring-0","onUpdate:modelValue":E=>n.text=E},null,8,bt)),[[ie,n.text]]):(a(),o("p",{key:1,class:q(["w-full p-2 border rounded-md",{"bg-gray-200":n.state==l(u).PENDING,"bg-green-200":n.state==l(u).ACCEPTED,"bg-red-200":n.state==l(u).REJECTED}])},f(n.text),3)),n.state!=l(u).PENDING?(a(),o("div",yt,[n.draft?p("",!0):(a(),o("p",{key:0,class:"text-xs underline",onClick:E=>t.$emit("onMentionClause",n)},"Mention",8,Ct)),s("p",{class:q({"text-green-400 text-xs":n.state==l(u).ACCEPTED,"text-red-400 text-xs":n.state==l(u).REJECTED})},f(n.state),3)])):p("",!0),s("div",wt,[n.draft?(a(),se(l(Re),{key:0,class:"h-5 w-5 text-green-400",onClick:E=>v(n)},null,8,["onClick"])):(a(),se(l(Te),{key:1,class:"h-5 w-5 text-blue-400",onClick:E=>te(n.id)},null,8,["onClick"])),w(l(Ie),{class:"h-5 w-5",onClick:E=>ee(n.id)},null,8,["onClick"])])]))),256))])])):p("",!0)]),s("span",null,[C.value&&C.value.length>0?(a(),o("span",$t,[s("label",It,f(l(c).name==e.value.sellerId?e.value.sellerId.substring(0,5):e.value.buyerId.substring(0,5))+"'s clauses",1),s("span",kt,[(a(!0),o(F,null,Q(C.value,n=>(a(),o("div",Et,[s("p",{class:q(["w-full p-2 border rounded-md",{"bg-gray-200":n.state==l(u).PENDING,"bg-green-200":n.state==l(u).ACCEPTED,"bg-red-200":n.state==l(u).REJECTED}])},f(n.text),3),s("div",Rt,[s("a",{class:"text-xs underline",onClick:E=>t.$emit("onMentionClause",n)},"Mention",8,Tt),s("div",Mt,[s("a",{class:"text-xs font-semibold text-green-400 underline decoration-green-400",onClick:E=>z(n.id,l(u).ACCEPTED)},"Approve",8,St),s("a",{class:"text-xs font-semibold text-red-400 underline decoration-red-400",onClick:E=>z(n.id,l(u).REJECTED)},"Reject",8,At)])])]))),256))])])):p("",!0)]),s("div",Dt,[s("div",null,[(h=e.value.ready)!=null&&h.includes(e.value.sellerId)?(a(),o("p",Lt,f(e.value.sellerId.substring(0,5))+" is ready",1)):p("",!0),(G=e.value.ready)!=null&&G.includes(e.value.buyerId)?(a(),o("p",Nt,f(e.value.buyerId.substring(0,5))+" is ready",1)):p("",!0)]),e.value.ready.includes(l(c).uid)?p("",!0):(a(),o("button",{key:0,onClick:g,class:"bg-blue-500 text-white px-4 h-8 rounded-md hover:bg-blue-400 transition duration-300 ease-in-out"},"Ready to Proceed ")),e.value.ready.includes(l(c).uid)?(a(),o("button",{key:1,onClick:d,class:"bg-red-500 text-white px-4 h-8 rounded-md hover:bg-red-400 transition duration-300 ease-in-out"},"Cancel ")):p("",!0)]),(H=e.value.ready)!=null&&H.includes(e.value.sellerId)&&((J=e.value.ready)!=null&&J.includes(e.value.buyerId))?(a(),se(me,{key:0,onClick:T,isLoading:k.value},{default:pe(()=>[ue("Proceed ")]),_:1},8,["isLoading"])):p("",!0)]))])):!e.value.id&&!L.value?(a(),o("div",Pt,Ut)):(a(),o("div",Ft,[w(X,{isLoading:M.value},null,8,["isLoading"])]))}}}),Vt={class:"grid grid-cols-2 gap-x-4 p-2"},Gt=oe({__name:"MessagingView",props:{adId:{type:String,required:!1},contractId:{type:String,required:!1}},setup(R){const D=x({}),r=b=>{!b||!b.id||b.draft||(D.value=b)},$=()=>{D.value={}};return(b,m)=>(a(),o("div",Vt,[w(st,{clauseMentionned:D.value,onOnRemoveMentionnedClause:$,adId:R.adId},null,8,["clauseMentionned","adId"]),w(qt,{adId:R.adId,onOnMentionClause:r},null,8,["adId"])]))}});export{Gt as default};
