import{e as o,f as a,g as s,d as _e,s as pe,a as te,h as u,V as ge,o as me,ac as xe,c as we,l as n,F as H,k as J,p as y,L as N,x,t as f,w as se,v as oe,ad as Ce,G as R,H as j,I as W,ae as v,M as h,J as O,af as B,ag as M,i as ye,a9 as A,z as be,A as ke,y as ae,ah as Ee,ai as $e}from"./index-3d6e13dc.js";function Le(b,p){return o(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"})])}function De(b,p){return o(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"})])}function Me(b,p){return o(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"})])}function Ae(b,p){return o(),a("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[s("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z","clip-rule":"evenodd"})])}function Ie(b,p){return o(),a("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[s("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z","clip-rule":"evenodd"})])}const Te={class:"grid grid-cols-2 gap-x-4 p-2"},Se={key:0,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},Ne=s("h1",{class:"text-xl font-semibold border-b pb-2"},"Messaging",-1),Re={key:0,class:"flex flex-col space-y-2 overflow-y-auto h-full"},je={class:"break-words"},Oe={key:0,class:"flex justify-between mb-2"},Be={class:"text-sm font-medium"},Ue={class:"text-sm font-medium"},Ve={class:"flex flex-col space-y-1"},ze={key:0,class:"truncate bg-gray-100 rounded-md p-2 max-w-xs md:max-w-md text-xs rounded-md p-1 bg-slate-200"},Pe=s("span",{class:"font-bold"},"clause:",-1),qe={class:"italic"},Ge={key:1,class:"flex justify-center items-center h-32"},Fe=s("p",{class:"text-gray-500"},"No messages yet",-1),He=[Fe],Je={key:2,class:"flex justify-center items-center h-32"},We={class:"flex items-end space-x-2"},Ke={class:"border rounded-md w-full p-2"},Qe={key:0,class:"relative w-full truncate bg-gray-100 rounded-md p-2 max-w-xs md:max-w-md text-xs rounded-md p-1 bg-slate-200"},Xe={class:"text-sm text-slate-500 truncate"},Ye=s("span",{class:"font-bold"},"clause: ",-1),Ze={class:"italic"},et={class:"h-full flex items-start"},tt={key:1,class:"flex justify-center items-center h-32"},st=s("p",{class:"text-gray-500"},"No chatroom found",-1),ot=[st],at={key:2},nt={key:3,class:"p-4 w-full mx-auto bg-white rounded-lg shadow-md flex flex-col space-y-4"},lt=s("h1",{class:"text-xl font-semibold border-b pb-2"},"Contract Draft",-1),rt={key:0,class:"flex flex-col space-y-4"},dt={key:0},it={class:"text-lg font-semibold border-b pb-2"},ct={class:"flex flex-col space-y-2"},ut={class:"relative break-words"},ft=["onUpdate:modelValue"],vt={key:2,class:"w-full flex justify-between"},ht=["onClick"],_t={class:"flex items-center space-x-1 absolute top-1 right-1"},pt={key:0},gt={class:"text-lg font-semibold border-b pb-2"},mt={class:"flex flex-col space-y-2"},xt={class:"relative break-words"},wt={class:"w-full flex justify-between"},Ct=["onClick"],yt={class:"flex space-x-2"},bt=["onClick"],kt=["onClick"],Et={key:1},$t={key:4},Lt=s("p",null,"No Contract Found",-1),Dt=[Lt],Mt={key:5},It=_e({__name:"MessagingView",props:{adId:{type:String,required:!1}},setup(b){const p="chatrooms",K="messages",g="contracts",w="clauses",Q=b,{user:_,profile:$}=pe(te()),L=u(!1),k=u(!1),I=u(!1),C=u(!1),D=u({}),r=u({}),T=u([]),S=u([]),m=u({}),c=u({}),E=u([]),i=te().CLAUSE_STATUSES;let U,V,z,P;const ne=ge(r,(t,l)=>{t.id&&(z=R(j(v(h,`${g}/${r.value.id}/${w}`),O("authorId","==",_.value.uid),W("createdAt","asc")),e=>{C.value=!0,console.log("user clauses changed"),T.value=e.docs.map(d=>({...d.data()})),C.value=!1}),P=R(j(v(h,`${g}/${r.value.id}/${w}`),O("authorId","!=",_.value.uid),O("draft","==",!1)),e=>{C.value=!0,console.log("other clauses changed"),S.value=e.docs.map(d=>({...d.data()})),C.value=!1}))}),le=async()=>{L.value=!0;const l=(await Ce(p,"adId","==",Q.adId))[0];if(!l)throw new Error("Chatroom not found");D.value={...l},L.value=!1,U=R(j(v(h,`${p}/${l.id}/${K}`),W("createdAt","asc")),e=>{k.value=!0,E.value=e.docs.map(d=>({...d.data()})),k.value=!1}),V=R(j(v(h,g),O("adId","==",Q.adId),W("createdAt","asc")),e=>{I.value=!0,console.log("contract changed"),r.value=e.docs[0].data(),I.value=!1})};me(async()=>{try{await le()}catch(t){t.message=="Chatroom not found"&&xe.push("/")}}),we(()=>{U&&U(),V&&V(),z&&z(),P&&P(),ne()});const X=u(!1),re=async()=>{if(X.value=!0,!D.value||!m.value.text||!_.value||!$.value)return;const t=v(h,p,D.value.id,K);m.value.quote=c.value,m.value.createdAt=new Date,m.value.senderId=_.value.uid,await Ee(t,m.value),m.value.text="",c.value={},X.value=!1},de=t=>{const l=new Date,e=t.toDate(),d=l.getTime()-e.getTime(),q=Math.floor(d/1e3),G=Math.floor(q/60),F=Math.floor(G/60),ee=Math.floor(F/24);return ee>0?`${ee} days ago`:F>0?`${F} hours ago`:G>0?`${G} minutes ago`:q>0?`${q} seconds ago`:"just now"},ie=t=>{if(t===0)return!0;const l=E.value[t-1],e=E.value[t];return l.senderId!==e.senderId},Y=t=>{!t||!t.id||t.draft||(c.value=t)},ce=()=>{c.value={}},ue=async()=>{const t=v(h,`${g}/${r.value.id}/${w}`),l={id:Math.random().toString(36).substring(7),text:"",draft:!0,state:i.PENDING,authorId:_.value.uid,createdAt:new Date,updatedAt:new Date};console.log("onAddClauseDraft",t,l.id),await B(M(t,l.id),l)},fe=async t=>{if(console.log("onRemoveClause",t),!t||!r.value.id)return;const l=v(h,`${g}/${r.value.id}/${w}`);await $e(M(l,t)),c.value.id==t&&(c.value={})},ve=async t=>{if(console.log("onEditClause",t),!t||!r.value.id)return;const l=v(h,`${g}/${r.value.id}/${w}`);await B(M(l,t),{draft:!0},{merge:!0}),c.value.id==t&&(c.value={})},Z=async(t,l)=>{if(console.log("onEditClause",t,l),!t||!r.value.id||!Object.values(i).includes(l))return;const e=v(h,`${g}/${r.value.id}/${w}`);await B(M(e,t),{state:l},{merge:!0}),c.value.id==t&&(c.value={})},he=async t=>{if(console.log("onEditClause",t),!t||!r.value.id)return;t.draft=!1;const l=v(h,`${g}/${r.value.id}/${w}`);await B(M(l,t.id),t,{merge:!0})};return(t,l)=>(o(),a("div",Te,[D.value.id&&!L.value&&n(_)&&n($)?(o(),a("div",Se,[Ne,E.value.length>0&&!k.value?(o(),a("div",Re,[(o(!0),a(H,null,J(E.value,(e,d)=>(o(),a("span",je,[ie(d)?(o(),a("div",Oe,[s("p",Be,f(e.senderId.substring(0,5))+" says:",1),s("p",Ue,f(de(e.createdAt)),1)])):x("",!0),s("div",{class:A([e.senderId!=n(_).uid?"justify-end":"justify-start","flex"])},[s("div",Ve,[e.quote?(o(),a("p",ze,[Pe,ye(),s("span",qe,f(e.quote.text),1)])):x("",!0),s("p",{class:A([e.senderId===n(_).uid?"bg-blue-500 text-white":"bg-gray-100","rounded-md p-2 max-w-xs md:max-w-md",e.quote?"ml-2":""])},f(e.text),3)])],2)]))),256))])):E.value.length==0&&!k.value?(o(),a("div",Ge,He)):k.value?(o(),a("div",Je,[y(N,{isLoading:k.value},null,8,["isLoading"])])):x("",!0),s("span",We,[s("div",Ke,[c.value.id?(o(),a("div",Qe,[y(n(Ie),{class:"h-4 w-4 absolute top-1 right-1",onClick:ce}),s("p",Xe,[Ye,s("span",Ze,f(c.value.text),1)])])):x("",!0),se(s("textarea",{"onUpdate:modelValue":l[0]||(l[0]=e=>m.value.text=e),class:"h-full w-full resize-none focus:outline-none",placeholder:"Type your message here..."},null,512),[[oe,m.value.text]])]),s("div",et,[y(n(Le),{onClick:re,class:"h-6 w-6 text-blue-500"})])])])):!D.value.id&&!L.value?(o(),a("div",tt,ot)):(o(),a("div",at,[y(N,{isLoading:L.value},null,8,["isLoading"])])),r.value.id&&!I.value?(o(),a("div",nt,[lt,s("div",null,[s("p",null,"Last Updated: "+f(n(be)(r.value.updatedAt)?n(ke)(r.value.updatedAt):r.value.updatedAt),1)]),s("button",{onClick:ue,class:"w-full border-dashed border-2 border-sky-500 rounded-sm p-1"},"Add Clause"),C.value?(o(),a("div",Et,[y(N,{isLoading:C.value},null,8,["isLoading"])])):(o(),a("div",rt,[s("span",null,[T.value&&T.value.length>0?(o(),a("span",dt,[s("label",it,f(n($)&&n($).name?`${n($).name}'s `:"My ")+"clauses",1),s("span",ct,[(o(!0),a(H,null,J(T.value,e=>(o(),a("div",ut,[e.draft?se((o(),a("textarea",{key:0,class:"w-full p-2 border rounded-md resize-none focus:border-blue-500 focus:ring-0","onUpdate:modelValue":d=>e.text=d},null,8,ft)),[[oe,e.text]]):(o(),a("p",{key:1,class:A(["w-full p-2 border rounded-md",{"bg-gray-200":e.state==n(i).PENDING,"bg-green-200":e.state==n(i).ACCEPTED,"bg-red-200":e.state==n(i).REJECTED}])},f(e.text),3)),e.state!=n(i).PENDING?(o(),a("div",vt,[e.draft?x("",!0):(o(),a("p",{key:0,class:"text-xs underline",onClick:d=>Y(e)},"Mention",8,ht)),s("p",{class:A({"text-green-400 text-xs":e.state==n(i).ACCEPTED,"text-red-400 text-xs":e.state==n(i).REJECTED})},f(e.state),3)])):x("",!0),s("div",_t,[e.draft?(o(),ae(n(Ae),{key:0,class:"h-4 w-4 text-green-400",onClick:d=>he(e)},null,8,["onClick"])):(o(),ae(n(De),{key:1,class:"h-4 w-4 text-blue-400",onClick:d=>ve(e.id)},null,8,["onClick"])),y(n(Me),{class:"h-4 w-4",onClick:d=>fe(e.id)},null,8,["onClick"])])]))),256))])])):x("",!0)]),s("span",null,[S.value&&S.value.length>0?(o(),a("span",pt,[s("label",gt,f(n(_).name==r.value.sellerId?r.value.sellerId.substring(0,5):r.value.buyerId.substring(0,5))+"'s clauses",1),s("span",mt,[(o(!0),a(H,null,J(S.value,e=>(o(),a("div",xt,[s("p",{class:A(["w-full p-2 border rounded-md",{"bg-gray-200":e.state==n(i).PENDING,"bg-green-200":e.state==n(i).ACCEPTED,"bg-red-200":e.state==n(i).REJECTED}])},f(e.text),3),s("div",wt,[s("p",{class:"text-xs underline",onClick:d=>Y(e)},"Mention",8,Ct),s("div",yt,[s("p",{class:"text-xs font-semibold text-green-400 underline decoration-green-400",onClick:d=>Z(e.id,n(i).ACCEPTED)},"Approve",8,bt),s("p",{class:"text-xs font-semibold text-red-400 underline decoration-red-400",onClick:d=>Z(e.id,n(i).REJECTED)},"Reject",8,kt)])])]))),256))])])):x("",!0)])]))])):!r.value.id&&!I.value?(o(),a("div",$t,Dt)):(o(),a("div",Mt,[y(N,{isLoading:C.value},null,8,["isLoading"])]))]))}});export{It as default};
